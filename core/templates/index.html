{% extends 'base.html' %}
{% load static %}

{% block title %}é¦–é¡µ - æ˜å¤©æœ€æƒ³åƒæ¦œ{% endblock %}

{% block content %}
<div class="container">
    <section class="hero">
        <h1 class="hero-title">ğŸŒŸ æ˜å¤©æœ€æƒ³åƒæ¦œ ğŸŒŸ</h1>
        <p class="hero-subtitle">ä¸ºæ˜å¤©çš„ç¾é£ŸæŠ•ä¸Šä½ çš„ä¸€ç¥¨ï¼</p>
    </section>

    <!-- æ’è¡Œæ¦œåŒºåŸŸ -->
    <section class="rankings-section">
        <!-- æ—©é¤æ’è¡Œ -->
        <div class="ranking-card breakfast-card">
            <div class="card-header">
                <h2 class="card-title">ğŸŒ… æ—©é¤ TOP 3</h2>
            </div>
            <div class="ranking-list" id="breakfast-ranking">
                <div class="loading">åŠ è½½ä¸­...</div>
            </div>
            <a href="{% url 'core:vote_page' %}#breakfast" class="vote-btn breakfast-btn">å»æŠ•ç¥¨</a>
        </div>

        <!-- åˆé¤æ’è¡Œ -->
        <div class="ranking-card lunch-card">
            <div class="card-header">
                <h2 class="card-title">â˜€ï¸ åˆé¤ TOP 5</h2>
            </div>
            <div class="ranking-list" id="lunch-ranking">
                <div class="loading">åŠ è½½ä¸­...</div>
            </div>
            <a href="{% url 'core:vote_page' %}#lunch" class="vote-btn lunch-btn">å»æŠ•ç¥¨</a>
        </div>

        <!-- æ™šé¤æ’è¡Œ -->
        <div class="ranking-card dinner-card">
            <div class="card-header">
                <h2 class="card-title">ğŸŒ™ æ™šé¤ TOP 5</h2>
            </div>
            <div class="ranking-list" id="dinner-ranking">
                <div class="loading">åŠ è½½ä¸­...</div>
            </div>
            <a href="{% url 'core:vote_page' %}#dinner" class="vote-btn dinner-btn">å»æŠ•ç¥¨</a>
        </div>
    </section>

    <!-- è¯äº‘åŒºåŸŸ -->
    <section class="wordcloud-section" onclick="window.location.href='{% url 'core:suggestion_page' %}'">
        <h2 class="section-title">ğŸ’¬ å¤§å®¶éƒ½åœ¨è¯´ä»€ä¹ˆ</h2>
        <div class="wordcloud-container" id="wordcloud">
            <div class="loading">åŠ è½½ä¸­...</div>
        </div>
        <p class="wordcloud-hint">ç‚¹å‡»è¿›å…¥æäº¤æ„è§å»ºè®®</p>
    </section>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // åŠ è½½æ’è¡Œæ¦œæ•°æ®
    async function loadRankings() {
        try {
            const response = await fetch('/api/rankings/');
            const data = await response.json();

            // æ¸²æŸ“æ—©é¤
            renderRanking('breakfast-ranking', data.breakfast, ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰']);

            // æ¸²æŸ“åˆé¤
            renderRanking('lunch-ranking', data.lunch, ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰', '4ï¸âƒ£', '5ï¸âƒ£']);

            // æ¸²æŸ“æ™šé¤
            renderRanking('dinner-ranking', data.dinner, ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰', '4ï¸âƒ£', '5ï¸âƒ£']);
        } catch (error) {
            console.error('åŠ è½½æ’è¡Œæ¦œå¤±è´¥:', error);
        }
    }

    function renderRanking(elementId, items, medals) {
        const container = document.getElementById(elementId);
        if (items.length === 0) {
            container.innerHTML = '<div class="empty-state">æš‚æ— æ•°æ®ï¼Œå¿«å»æŠ•ç¥¨å§ï¼</div>';
            return;
        }

        const html = items.map((item, index) => `
            <div class="ranking-item" data-rank="${index + 1}">
                <span class="rank-medal">${medals[index]}</span>
                <span class="food-name">${item.name}</span>
                <span class="vote-count">${item.votes} ç¥¨</span>
            </div>
        `).join('');

        container.innerHTML = html;
    }

    // åŠ è½½è¯äº‘æ•°æ®
    async function loadWordcloud() {
        try {
            const response = await fetch('/api/wordcloud/');
            const data = await response.json();

            const container = document.getElementById('wordcloud');
            if (data.words.length === 0) {
                container.innerHTML = '<div class="empty-state">æš‚æ— æ•°æ®</div>';
                return;
            }

            // ç”Ÿæˆè¯äº‘HTML
            const html = data.words.map((word, index) => {
                const size = Math.max(14, Math.min(36, word.weight * 0.8));
                const delay = index * 0.1;
                return `<span class="word" style="font-size: ${size}px; animation-delay: ${delay}s">${word.text}</span>`;
            }).join('');

            container.innerHTML = html;
        } catch (error) {
            console.error('åŠ è½½è¯äº‘å¤±è´¥:', error);
        }
    }

    // é¡µé¢åŠ è½½æ—¶è·å–æ•°æ®
    document.addEventListener('DOMContentLoaded', () => {
        loadRankings();
        loadWordcloud();

        // æ¯30ç§’åˆ·æ–°ä¸€æ¬¡æ’è¡Œæ¦œ
        setInterval(loadRankings, 30000);
    });
</script>
{% endblock %}