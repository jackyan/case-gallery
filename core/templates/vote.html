{% extends 'base.html' %}
{% load static %}

{% block title %}æŠ•ç¥¨ - ä¸ºæ˜å¤©çš„ç¾é£ŸæŠ•ç¥¨{% endblock %}

{% block content %}
<div class="container">
    <section class="hero">
        <h1 class="hero-title">ğŸ—³ï¸ ä¸ºæ˜å¤©çš„ç¾é£ŸæŠ•ç¥¨</h1>
        <p class="hero-subtitle">æ¯ä¸ªIPæ¯å¤©åªèƒ½ä¸ºåŒä¸€é£Ÿç‰©æŠ•ä¸€ç¥¨</p>
    </section>

    <!-- Tab å¯¼èˆª -->
    <div class="tabs">
        <button class="tab-btn active" data-tab="breakfast">ğŸŒ… æ—©é¤</button>
        <button class="tab-btn" data-tab="lunch">â˜€ï¸ åˆé¤</button>
        <button class="tab-btn" data-tab="dinner">ğŸŒ™ æ™šé¤</button>
    </div>

    <!-- æ—©é¤é€‰é¡¹ -->
    <div class="tab-content active" id="breakfast">
        <div class="food-grid">
            {% for food in breakfast_foods %}
            <div class="food-card" data-food-id="{{ food.id }}">
                {% if food.image %}
                <div class="food-image" style="background-image: url('{{ food.image.url }}')"></div>
                {% else %}
                <div class="food-image food-placeholder">ğŸ½ï¸</div>
                {% endif %}
                <div class="food-info">
                    <h3 class="food-name">{{ food.name }}</h3>
                    {% if food.description %}
                    <p class="food-desc">{{ food.description }}</p>
                    {% endif %}
                </div>
                <button class="vote-button breakfast-btn" onclick="vote({{ food.id }}, '{{ food.name }}')">æŠ•ç¥¨</button>
            </div>
            {% empty %}
            <p class="empty-state">æš‚æ— æ—©é¤é€‰é¡¹</p>
            {% endfor %}
        </div>
    </div>

    <!-- åˆé¤é€‰é¡¹ -->
    <div class="tab-content" id="lunch">
        <div class="food-grid">
            {% for food in lunch_foods %}
            <div class="food-card" data-food-id="{{ food.id }}">
                {% if food.image %}
                <div class="food-image" style="background-image: url('{{ food.image.url }}')"></div>
                {% else %}
                <div class="food-image food-placeholder">ğŸ½ï¸</div>
                {% endif %}
                <div class="food-info">
                    <h3 class="food-name">{{ food.name }}</h3>
                    {% if food.description %}
                    <p class="food-desc">{{ food.description }}</p>
                    {% endif %}
                </div>
                <button class="vote-button lunch-btn" onclick="vote({{ food.id }}, '{{ food.name }}')">æŠ•ç¥¨</button>
            </div>
            {% empty %}
            <p class="empty-state">æš‚æ— åˆé¤é€‰é¡¹</p>
            {% endfor %}
        </div>
    </div>

    <!-- æ™šé¤é€‰é¡¹ -->
    <div class="tab-content" id="dinner">
        <div class="food-grid">
            {% for food in dinner_foods %}
            <div class="food-card" data-food-id="{{ food.id }}">
                {% if food.image %}
                <div class="food-image" style="background-image: url('{{ food.image.url }}')"></div>
                {% else %}
                <div class="food-image food-placeholder">ğŸ½ï¸</div>
                {% endif %}
                <div class="food-info">
                    <h3 class="food-name">{{ food.name }}</h3>
                    {% if food.description %}
                    <p class="food-desc">{{ food.description }}</p>
                    {% endif %}
                </div>
                <button class="vote-button dinner-btn" onclick="vote({{ food.id }}, '{{ food.name }}')">æŠ•ç¥¨</button>
            </div>
            {% empty %}
            <p class="empty-state">æš‚æ— æ™šé¤é€‰é¡¹</p>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Toast æç¤º -->
<div id="toast" class="toast"></div>
{% endblock %}

{% block extra_js %}
<script>
    // Tab åˆ‡æ¢
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            // ç§»é™¤æ‰€æœ‰æ¿€æ´»çŠ¶æ€
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            // æ·»åŠ å½“å‰æ¿€æ´»çŠ¶æ€
            btn.classList.add('active');
            document.getElementById(btn.dataset.tab).classList.add('active');
        });
    });

    // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥é”šç‚¹
    window.addEventListener('DOMContentLoaded', () => {
        const hash = window.location.hash.substring(1);
        if (hash && ['breakfast', 'lunch', 'dinner'].includes(hash)) {
            const btn = document.querySelector(`[data-tab="${hash}"]`);
            if (btn) btn.click();
        }
    });

    // è·å– CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // æ˜¾ç¤ºæç¤º
    function showToast(message, type = 'success') {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.className = `toast ${type} show`;

        setTimeout(() => {
            toast.classList.remove('show');
        }, 3000);
    }

    // æŠ•ç¥¨å‡½æ•°
    async function vote(foodId, foodName) {
        try {
            const formData = new FormData();
            formData.append('food_id', foodId);
            formData.append('csrfmiddlewaretoken', getCookie('csrftoken'));

            const response = await fetch('/api/vote/', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            });

            const data = await response.json();

            if (data.success) {
                showToast(`âœ… æˆåŠŸä¸ºã€Œ${foodName}ã€æŠ•ç¥¨ï¼`, 'success');
            } else {
                showToast(`âŒ ${data.error}`, 'error');
            }
        } catch (error) {
            showToast('âŒ æŠ•ç¥¨å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
            console.error('æŠ•ç¥¨é”™è¯¯:', error);
        }
    }
</script>
{% endblock %}